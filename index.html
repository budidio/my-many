<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Keuangan Bulanan ‚Äî Sinkron Google Sheet</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#f3f6fb; --card:#ffffff; --muted:#6b7280; --primary:#60a5fa; --accent:#2563eb;
    }
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#0f172a}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .panel{width:100%;max-width:960px}
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    .title{font-size:20px;font-weight:600;color:var(--accent);text-align:center;margin-bottom:6px}
    .login-center{display:flex;flex-direction:column;gap:14px}
    input,select,button{padding:10px;border-radius:10px;border:1px solid #e5e7eb;font-size:15px}
    button{background:var(--accent);color:white;font-weight:600;cursor:pointer;border:none}
    .ghost{background:transparent;color:var(--accent);border:1px solid #cfe1ff}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:10px}
    form.row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eef4ff;text-align:left;font-size:14px}
    th{color:#6b7280}
    .right{text-align:right}
    .summary{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    .item{background:#fbfdff;padding:10px;border-radius:10px;border:1px solid #eef7ff;text-align:center}
    .item h3{margin:0;color:#6b7280;font-size:14px}
    .item div{font-weight:700;font-size:16px;margin-top:4px}
    .toggle-eye{cursor:pointer;font-size:16px;margin-left:6px;color:var(--accent)}
    .chart-container{position:relative;height:180px;width:100%;margin-top:12px;border-radius:10px;padding:10px;background:#fff;border:1px solid #eef4ff}
    @media(max-width:600px){
      .summary{grid-template-columns:1fr;gap:8px}
      form.row{flex-direction:column}
    }
    @media print {
      button, select, form { display: none !important; }
      .chart-container { display: none !important; }
      .card { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">

      <!-- LOGIN -->
      <div id="loginCard" class="card">
        <div class="login-center">
          <div class="title">Masuk ‚Äî Sistem Keuangan</div>
          <label>Username</label>
          <input id="username" type="text" placeholder="Username" />
          <label>Password</label>
          <input id="password" type="password" placeholder="Password" />
          <button id="btnLogin">Masuk</button>
          <div id="loginErr" style="color:#b91c1c;display:none;font-size:13px"></div>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div id="dash" class="card" style="display:none">
        <div class="topbar">
          <div>
            <div style="font-weight:700;color:var(--accent)">Keuangan Bulanan</div>
            <small id="currentMonth"></small>
          </div>
          <div style="display:flex;gap:6px">
            <select id="monthFilter"></select>
            <button class="ghost" id="btnPrint">üñ®Ô∏è Cetak</button>
            <button class="ghost" id="btnLogout">Keluar</button>
          </div>
        </div>

        <!-- Form input -->
        <form id="entryForm" class="row">
          <input type="date" id="date" required />
          <input type="text" id="desc" placeholder="Deskripsi" required />
          <select id="type">
            <option value="income">Pemasukan</option>
            <option value="expense">Pengeluaran</option>
          </select>
          <input type="number" id="amount" placeholder="Nominal" required />
          <button type="submit">Tambah</button>
        </form>

        <!-- Ringkasan -->
        <div class="summary">
          <div class="item">
            <h3>Total Pemasukan <span class="toggle-eye" id="eyeIncome">üëÅÔ∏è</span></h3>
            <div id="totalIncome">******</div>
          </div>
          <div class="item">
            <h3>Total Pengeluaran</h3>
            <div id="totalExpense">Rp 0</div>
          </div>
          <div class="item">
            <h3>Saldo <span class="toggle-eye" id="eyeBalance">üëÅÔ∏è</span></h3>
            <div id="balance">******</div>
          </div>
          <div class="item">
            <h3>Jumlah Transaksi</h3>
            <div id="count">0</div>
          </div>
        </div>

        <!-- Grafik -->
        <div class="chart-container"><canvas id="chart"></canvas></div>

        <!-- Tabel -->
        <div style="overflow:auto;margin-top:20px">
          <table>
            <thead>
              <tr><th>Tanggal</th><th>Deskripsi</th><th>Jenis</th><th class="right">Nominal</th></tr>
            </thead>
            <tbody id="entriesTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
  const SHEET_API = "https://script.google.com/macros/s/AKfycbzQlv_kZWPGhmQSyRk7HCUrpqVnjdpdfH8x1vpqhlzbvVs0WguQZW_e4EfKtshVQUnfzA/exec";
  const USER="admin",PASS="1122aabb";

  // Elemen utama
  const loginCard=document.getElementById("loginCard");
  const dash=document.getElementById("dash");
  const loginErr=document.getElementById("loginErr");
  const btnLogin=document.getElementById("btnLogin");
  const btnLogout=document.getElementById("btnLogout");

  btnLogin.onclick=()=>{
    const u=username.value.trim(),p=password.value.trim();
    if(u===USER&&p===PASS){
      loginCard.style.display="none";
      dash.style.display="block";
      loadFromSheet();
    }else{
      loginErr.style.display="block";
      loginErr.textContent="Username atau password salah!";
    }
  };

  btnLogout.onclick=()=>{
    dash.style.display="none";
    loginCard.style.display="block";
  };

  // Variabel global
  let entries=[],filtered=[];
  let hideIncome=true,hideBalance=true;

  const tbody=document.getElementById("entriesTable");
  const totalIncomeEl=document.getElementById("totalIncome");
  const totalExpenseEl=document.getElementById("totalExpense");
  const balanceEl=document.getElementById("balance");
  const countEl=document.getElementById("count");
  const monthFilter=document.getElementById("monthFilter");

  const ctx=document.getElementById("chart").getContext("2d");
  let myChart=new Chart(ctx,{type:"line",data:{labels:[],datasets:[]},options:{responsive:true,maintainAspectRatio:false}});

  function fmt(n){return Number(n).toLocaleString('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0});}
  function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8);}

  async function loadFromSheet(){
    try{
      const res=await fetch(SHEET_API);
      const rows=await res.json();
      entries=rows.slice(1).map(r=>({id:uid(),date:r[0],desc:r[1],type:r[2],amount:Number(r[3])}));
      setupMonthFilter();applyFilter();
    }catch(e){alert("Gagal ambil data dari Google Sheets");console.error(e);}
  }

  async function sendToSheet(entry){
    const fd=new FormData();
    fd.append("date",entry.date);
    fd.append("desc",entry.desc);
    fd.append("type",entry.type);
    fd.append("amount",entry.amount);
    try{await fetch(SHEET_API,{method:"POST",mode:"no-cors",body:fd});}
    catch(e){console.error("Gagal kirim:",e);}
  }

  document.getElementById("entryForm").addEventListener("submit",async e=>{
    e.preventDefault();
    const date=document.getElementById("date").value,
          desc=document.getElementById("desc").value.trim(),
          type=document.getElementById("type").value,
          amount=Number(document.getElementById("amount").value);
    if(!date||!desc||!amount)return alert("Lengkapi semua kolom!");
    const entry={id:uid(),date,desc,type,amount};
    entries.push(entry);applyFilter();e.target.reset();await sendToSheet(entry);
  });

  monthFilter.addEventListener("change",applyFilter);

  function setupMonthFilter(){
    const months=[...new Set(entries.map(e=>{const d=new Date(e.date);return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}))].sort().reverse();
    const now=new Date();const currentMonth=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    monthFilter.innerHTML=months.map(m=>{
      const [y,mo]=m.split('-');
      const nm=new Date(y,mo-1).toLocaleString('id-ID',{month:'long',year:'numeric'});
      return `<option value="${m}" ${m===currentMonth?'selected':''}>${nm}</option>`;
    }).join('');
    if(!months.includes(currentMonth)&&months.length>0)monthFilter.value=months[0];
  }

  function applyFilter(){
    const val=monthFilter.value;
    if(!val)return;
    const [y,m]=val.split('-').map(Number);
    filtered=entries.filter(e=>{
      const d=new Date(e.date);
      return d.getFullYear()===y&&d.getMonth()+1===m;
    });
    render();
  }

  function render(){
    tbody.innerHTML=filtered.map(r=>{
      const d=new Date(r.date);
      return `<tr><td>${d.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})}</td><td>${r.desc}</td><td>${r.type==='income'?'Pemasukan':'Pengeluaran'}</td><td class='right'>${fmt(r.amount)}</td></tr>`;
    }).join('');
    const totalIncome=filtered.filter(e=>e.type==='income').reduce((s,v)=>s+v.amount,0);
    const totalExpense=filtered.filter(e=>e.type==='expense').reduce((s,v)=>s+v.amount,0);
    totalIncomeEl.textContent=hideIncome?"******":fmt(totalIncome);
    totalExpenseEl.textContent=fmt(totalExpense);
    balanceEl.textContent=hideBalance?"******":fmt(totalIncome-totalExpense);
    countEl.textContent=filtered.length;
    updateChart();
  }

  function updateChart(){
    const labels=filtered.map(e=>{const d=new Date(e.date);return d.toLocaleDateString('id-ID',{day:'2-digit',month:'short'});});
    const income=filtered.map(e=>e.type==='income'?e.amount:0);
    const expense=filtered.map(e=>e.type==='expense'?-e.amount:0);
    myChart.data={labels,datasets:[
      {label:'Pemasukan',data:income,borderColor:'#16a34a',backgroundColor:'rgba(22,163,74,0.1)',fill:true,tension:0.3},
      {label:'Pengeluaran',data:expense,borderColor:'#dc2626',backgroundColor:'rgba(220,38,38,0.1)',fill:true,tension:0.3}
    ]};myChart.update();
  }

  // üëÅÔ∏è Toggle visibilitas
  document.getElementById("eyeIncome").onclick=()=>{hideIncome=!hideIncome;render();}
  document.getElementById("eyeBalance").onclick=()=>{hideBalance=!hideBalance;render();}

  // üñ®Ô∏è Cetak
  document.getElementById("btnPrint").onclick=()=>window.print();
  </script>
</body>
</html>
