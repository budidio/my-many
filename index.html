<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Keuangan Bulanan </title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#f3f6fb; --card:#ffffff; --muted:#6b7280; --primary:#60a5fa; --accent:#2563eb;
    }
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#0f172a}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .panel{width:100%;max-width:980px}
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    .title{font-size:20px;font-weight:600;color:var(--accent);text-align:center;margin-bottom:6px}
    .login-center{display:flex;flex-direction:column;gap:14px}
    input,select,button{padding:10px;border-radius:10px;border:1px solid #e5e7eb}
    button{background:var(--accent);color:white;font-weight:600;cursor:pointer}
    .ghost{background:transparent;color:var(--accent);border:1px solid #cfe1ff}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:10px}
    form.row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eef4ff;text-align:left;font-size:14px}
    th{color:#6b7280}
    .right{text-align:right}
    .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    .summary .item{background:#fbfdff;padding:10px;border-radius:10px;border:1px solid #eef7ff}
    .chart-container{position:relative;height:160px;width:100%;margin-top:12px;border-radius:10px;padding:10px;background:#fff;border:1px solid #eef4ff}
    .hide{display:none}
    @media print {
      button, select, form { display: none !important; }
      .chart-container { display: none !important; }
      .card { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">

      <!-- LOGIN -->
      <div id="loginCard" class="card">
        <div class="login-center">
          <div class="title">Masuk â€” Sistem Keuangan</div>
          <label>Username</label>
          <input id="username" type="text" placeholder="Username" />
          <label>Password</label>
          <input id="password" type="password" placeholder="Password" />
          <button id="btnLogin">Masuk</button>
          <div id="loginErr" style="color:#b91c1c;display:none;font-size:13px"></div>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div id="dash" class="card hide">
        <div class="topbar">
          <div>
            <div style="font-weight:700;color:var(--accent)">Keuangan Bulanan</div>
            <small id="currentMonth"></small>
          </div>
          <div class="flex" style="display:flex;gap:6px">
            <select id="monthFilter"></select>
            <button class="ghost" id="btnPrint">Cetak</button>
            <button class="ghost" id="btnLogout">Keluar</button>
          </div>
        </div>

        <!-- Form input -->
        <form id="entryForm" class="row">
          <input type="date" id="date" required />
          <input type="text" id="desc" placeholder="Deskripsi" required />
          <select id="type">
            <option value="income">Pemasukan</option>
            <option value="expense">Pengeluaran</option>
          </select>
          <input type="number" id="amount" placeholder="Nominal" required />
          <button type="submit">Tambah</button>
        </form>

        <!-- Ringkasan -->
        <div class="summary">
          <div class="item"><div>Total Pemasukan</div><div id="totalIncome">Rp 0</div></div>
          <div class="item"><div>Total Pengeluaran</div><div id="totalExpense">Rp 0</div></div>
          <div class="item"><div>Saldo</div><div id="balance">Rp 0</div></div>
          <div class="item"><div>Jumlah Transaksi</div><div id="count">0</div></div>
        </div>

        <!-- Grafik -->
        <div class="chart-container"><canvas id="chart"></canvas></div>

        <!-- Tabel (dipindah ke bawah grafik) -->
        <div style="overflow:auto;margin-top:20px">
          <table>
            <thead>
              <tr><th>Tanggal</th><th>Deskripsi</th><th>Jenis</th><th class="right">Nominal</th></tr>
            </thead>
            <tbody id="entriesTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SHEET_API = "https://script.google.com/macros/s/AKfycbzQlv_kZWPGhmQSyRk7HCUrpqVnjdpdfH8x1vpqhlzbvVs0WguQZW_e4EfKtshVQUnfzA/exec";
    const USER = "admin", PASS = "1122aabb";

    const loginCard = document.getElementById("loginCard");
    const dash = document.getElementById("dash");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const loginErr = document.getElementById("loginErr");
    const monthFilter = document.getElementById("monthFilter");
    const btnPrint = document.getElementById("btnPrint");

    btnLogin.onclick = () => {
      const u = username.value.trim(), p = password.value.trim();
      if (u === USER && p === PASS) { loginCard.classList.add("hide"); dash.classList.remove("hide"); loadFromSheet(); }
      else { loginErr.style.display="block"; loginErr.textContent="Username atau password salah"; }
    };
    btnLogout.onclick = ()=>{ loginCard.classList.remove("hide"); dash.classList.add("hide"); };
    btnPrint.onclick = ()=> window.print();

    let entries = [], filtered = [];
    const tbody = document.getElementById("entriesTable");
    const totalIncomeEl = document.getElementById("totalIncome");
    const totalExpenseEl = document.getElementById("totalExpense");
    const balanceEl = document.getElementById("balance");
    const countEl = document.getElementById("count");

    const ctx = document.getElementById("chart").getContext("2d");
    let myChart = new Chart(ctx, { type:"line", data:{labels:[],datasets:[]}, options:{responsive:true,maintainAspectRatio:false} });

    function fmt(n){return Number(n).toLocaleString('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0})}
    function formatTanggal(val){
      const d = new Date(val);
      return isNaN(d) ? val : d.toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"});
    }

    async function loadFromSheet(){
      const res = await fetch(SHEET_API);
      const rows = await res.json();
      entries = rows.slice(1).map(r=>({date:r[0],desc:r[1],type:r[2],amount:Number(r[3])}));
      updateMonthFilter();
      applyFilter();
    }

    async function sendToSheet(entry){
      const formData = new FormData();
      formData.append("date", entry.date);
      formData.append("desc", entry.desc);
      formData.append("type", entry.type);
      formData.append("amount", entry.amount);
      await fetch(SHEET_API, { method:"POST", mode:"no-cors", body:formData });
    }

    entryForm.onsubmit = async e=>{
      e.preventDefault();
      const entry = {
        date: date.value,
        desc: desc.value.trim(),
        type: type.value,
        amount: Number(amount.value)
      };
      if(!entry.date || !entry.desc || !entry.amount) return alert("Lengkapi semua kolom!");
      entries.push(entry);
      await sendToSheet(entry);
      entryForm.reset();
      updateMonthFilter();
      applyFilter();
    };

    function updateMonthFilter(){
      const months = [...new Set(entries.map(e=> new Date(e.date).toISOString().slice(0,7)))].sort().reverse();
      monthFilter.innerHTML = `<option value="">Semua Bulan</option>` +
        months.map(m=>`<option value="${m}">${new Date(m+"-01").toLocaleDateString("id-ID",{month:"long",year:"numeric"})}</option>`).join('');
    }

    monthFilter.onchange = ()=>applyFilter();

    function applyFilter() {
      const filterVal = monthFilter.value;
      if (!filterVal) {
        filtered = entries;
        } else {
        const [year, month] = filterVal.split('-').map(Number);
        filtered = entries.filter(e => {
          const d = new Date(e.date);
          return d.getFullYear() === year && d.getMonth() + 1 === month;
          });
      }
      render();
    }


    function render(){
      tbody.innerHTML = filtered.map(r=>`
        <tr>
          <td>${formatTanggal(r.date)}</td>
          <td>${r.desc}</td>
          <td>${r.type==="income"?"Pemasukan":"Pengeluaran"}</td>
          <td class="right">${fmt(r.amount)}</td>
        </tr>`).join('');
      const totalIncome = filtered.filter(e=>e.type==='income').reduce((s,v)=>s+v.amount,0);
      const totalExpense = filtered.filter(e=>e.type==='expense').reduce((s,v)=>s+v.amount,0);
      totalIncomeEl.textContent = fmt(totalIncome);
      totalExpenseEl.textContent = fmt(totalExpense);
      balanceEl.textContent = fmt(totalIncome-totalExpense);
      countEl.textContent = filtered.length;
      updateChart();
    }

    function updateChart(){
      const labels = filtered.map(e=>formatTanggal(e.date));
      const income = filtered.map(e=> e.type==='income'?e.amount:0);
      const expense = filtered.map(e=> e.type==='expense'?-e.amount:0);
      myChart.data = {
        labels,
        datasets:[
          {label:"Pemasukan",data:income,borderColor:"#16a34a",backgroundColor:"rgba(22,163,74,0.1)",fill:true,tension:0.3},
          {label:"Pengeluaran",data:expense,borderColor:"#dc2626",backgroundColor:"rgba(220,38,38,0.1)",fill:true,tension:0.3}
        ]
      };
      myChart.update();
    }
  </script>
</body>
</html>
