<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Keuangan Bulanan ‚Äî Google Sheet</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f3f6fb;
      --card: #ffffff;
      --accent: #2563eb;
      --muted: #6b7280;
    }
    body {
      margin: 0;
      background: var(--bg);
      font-family: 'Inter', system-ui, sans-serif;
      color: #0f172a;
    }
    .wrap {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 18px;
    }
    .panel {
      width: 100%;
      max-width: 980px;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 6px 20px rgba(2,6,23,0.06);
    }
    input, select, button {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    button {
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    button.ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid #cfe1ff;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    form.row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #eef4ff;
      text-align: left;
      font-size: 14px;
    }
    th { color: var(--muted); }
    .right { text-align: right; }
    .summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 600px) {
      .summary { grid-template-columns: repeat(2, 1fr); }
    }
    .item {
      background: #fbfdff;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #eef7ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .item .value {
      font-weight: 600;
      margin-top: 4px;
    }
    .chart-container {
      margin-top: 12px;
      padding: 10px;
      background: white;
      border-radius: 10px;
      border: 1px solid #eef4ff;
      height: 180px;
    }
    .hide { display: none; }
    @media print {
      button, select, form { display: none !important; }
      .chart-container { display: none !important; }
      .card { box-shadow: none; }
    }
    .eye {
      cursor: pointer;
      font-size: 14px;
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">

      <!-- LOGIN -->
      <div id="loginCard" class="card">
        <div class="title" style="text-align:center;font-size:20px;font-weight:600;color:var(--accent);margin-bottom:10px;">Masuk ‚Äî Sistem Keuangan</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <label>Username</label>
          <input id="username" type="text" placeholder="Username" />
          <label>Password</label>
          <input id="password" type="password" placeholder="Password" />
          <button id="btnLogin">Masuk</button>
          <div id="loginErr" style="color:#b91c1c;display:none;font-size:13px"></div>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div id="dash" class="card hide">
        <div class="topbar">
          <div>
            <div style="font-weight:700;color:var(--accent)">Keuangan Bulanan</div>
            <small id="currentMonth"></small>
          </div>
          <div style="display:flex;gap:6px">
            <select id="monthFilter"></select>
            <button class="ghost" id="btnPrint">üñ®Ô∏è Cetak</button>
            <button class="ghost" id="btnLogout">Keluar</button>
          </div>
        </div>

        <!-- Form input -->
        <form id="entryForm" class="row">
          <input type="date" id="date" required />
          <input type="text" id="desc" placeholder="Deskripsi" required />
          <select id="type">
            <option value="income">Pemasukan</option>
            <option value="expense">Pengeluaran</option>
          </select>
          <input type="number" id="amount" placeholder="Nominal" required />
          <button type="submit">Tambah</button>
        </form>

        <!-- Ringkasan -->
        <div class="summary">
          <div class="item">
            <div>Total Pemasukan <span id="eyeIncome" class="eye">üëÅÔ∏è</span></div>
            <div id="totalIncome" class="value">******</div>
          </div>
          <div class="item">
            <div>Total Pengeluaran</div>
            <div id="totalExpense" class="value">Rp 0</div>
          </div>
          <div class="item">
            <div>Saldo <span id="eyeBalance" class="eye">üëÅÔ∏è</span></div>
            <div id="balance" class="value">******</div>
          </div>
          <div class="item">
            <div>Jumlah Transaksi</div>
            <div id="count" class="value">0</div>
          </div>
        </div>

        <!-- Grafik -->
        <div class="chart-container"><canvas id="chart"></canvas></div>

        <!-- Tabel -->
        <div style="overflow:auto;margin-top:20px">
          <table>
            <thead>
              <tr><th>Tanggal</th><th>Deskripsi</th><th>Jenis</th><th class="right">Nominal</th></tr>
            </thead>
            <tbody id="entriesTable"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
  const SHEET_API = "https://script.google.com/macros/s/AKfycbzQlv_kZWPGhmQSyRk7HCUrpqVnjdpdfH8x1vpqhlzbvVs0WguQZW_e4EfKtshVQUnfzA/exec";
  const USER="admin",PASS="1122aabb";

  const loginCard=document.getElementById("loginCard");
  const dash=document.getElementById("dash");
  const btnLogin=document.getElementById("btnLogin");
  const btnLogout=document.getElementById("btnLogout");
  const loginErr=document.getElementById("loginErr");
  const monthFilter=document.getElementById("monthFilter");
  const tbody=document.getElementById("entriesTable");
  const totalIncomeEl=document.getElementById("totalIncome");
  const totalExpenseEl=document.getElementById("totalExpense");
  const balanceEl=document.getElementById("balance");
  const countEl=document.getElementById("count");

  btnLogin.onclick=()=>{
    const u=username.value.trim(),p=password.value.trim();
    if(u===USER&&p===PASS){
      loginCard.classList.add("hide");
      dash.classList.remove("hide");
      loadFromSheet();
    } else {
      loginErr.style.display="block";
      loginErr.textContent="Username atau password salah";
    }
  };
  btnLogout.onclick=()=>{loginCard.classList.remove("hide");dash.classList.add("hide");};

  let entries=[],filtered=[];
  const ctx=document.getElementById("chart").getContext("2d");
  let myChart=new Chart(ctx,{type:"line",data:{labels:[],datasets:[]},options:{responsive:true,maintainAspectRatio:false}});

  function fmt(n){return Number(n).toLocaleString('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0});}

  async function loadFromSheet(){
    try{
      const res=await fetch(SHEET_API);
      const rows=await res.json();
      entries=rows.slice(1).map(r=>({date:r[0],desc:r[1],type:r[2],amount:Number(r[3])}));
      setupMonthFilter();applyFilter();
    }catch(e){alert("Gagal ambil data dari Google Sheets");console.error(e);}
  }

  async function sendToSheet(entry){
    try{
      const fd=new FormData();
      fd.append("date",entry.date);
      fd.append("desc",entry.desc);
      fd.append("type",entry.type);
      fd.append("amount",entry.amount);
      await fetch(SHEET_API,{method:"POST",mode:"no-cors",body:fd});
    }catch(e){console.error("Gagal kirim:",e);}
  }

  document.getElementById("entryForm").addEventListener("submit",async e=>{
    e.preventDefault();
    const date=document.getElementById("date").value;
    const desc=document.getElementById("desc").value.trim();
    const type=document.getElementById("type").value;
    const amount=Number(document.getElementById("amount").value);
    if(!date||!desc||!amount)return alert("Lengkapi semua kolom!");
    const entry={date,desc,type,amount};
    entries.push(entry);
    applyFilter();
    e.target.reset();
    await sendToSheet(entry);
  });

  function setupMonthFilter(){
    const months=[...new Set(entries.map(e=>{
      const d=new Date(e.date);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }))].sort().reverse();
    const now=new Date();
    const currentMonth=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    monthFilter.innerHTML=months.map(m=>{
      const [y,mo]=m.split('-');
      const nm=new Date(y,mo-1).toLocaleString('id-ID',{month:'long',year:'numeric'});
      return `<option value="${m}" ${m===currentMonth?'selected':''}>${nm}</option>`;
    }).join('');
    if(!months.includes(currentMonth)&&months.length>0)monthFilter.value=months[0];
  }

  monthFilter.addEventListener("change",applyFilter);

  function applyFilter(){
    const val=monthFilter.value;
    const [y,m]=val.split('-').map(Number);
    filtered=entries.filter(e=>{
      const d=new Date(e.date);
      return d.getFullYear()===y&&d.getMonth()+1===m;
    });
    render();
  }

  function render(){
    tbody.innerHTML=filtered.map(r=>{
      const d=new Date(r.date);
      return `<tr>
        <td>${d.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})}</td>
        <td>${r.desc}</td>
        <td>${r.type==='income'?'Pemasukan':'Pengeluaran'}</td>
        <td class='right'>${fmt(r.amount)}</td>
      </tr>`;
    }).join('');
    const totalIncome=filtered.filter(e=>e.type==='income').reduce((s,v)=>s+v.amount,0);
    const totalExpense=filtered.filter(e=>e.type==='expense').reduce((s,v)=>s+v.amount,0);
    totalExpenseEl.textContent=fmt(totalExpense);
    totalIncomeEl.dataset.value=totalIncome;
    balanceEl.dataset.value=totalIncome-totalExpense;
    if(!incomeHidden) totalIncomeEl.textContent=fmt(totalIncome); else totalIncomeEl.textContent="******";
    if(!balanceHidden) balanceEl.textContent=fmt(totalIncome-totalExpense); else balanceEl.textContent="******";
    countEl.textContent=filtered.length;
    updateChart();
  }

  // üîπ Grafik per hari
  function updateChart(){
    const dailyData={};
    filtered.forEach(e=>{
      const d=new Date(e.date).toLocaleDateString('id-ID');
      if(!dailyData[d]) dailyData[d]={income:0,expense:0};
      if(e.type==='income') dailyData[d].income+=e.amount;
      else dailyData[d].expense+=e.amount;
    });
    const labels=Object.keys(dailyData);
    const income=labels.map(d=>dailyData[d].income);
    const expense=labels.map(d=>-dailyData[d].expense);
    myChart.data={labels,datasets:[
      {label:'Pemasukan',data:income,borderColor:'#16a34a',backgroundColor:'rgba(22,163,74,0.1)',fill:true,tension:0.3},
      {label:'Pengeluaran',data:expense,borderColor:'#dc2626',backgroundColor:'rgba(220,38,38,0.1)',fill:true,tension:0.3}
    ]};
    myChart.update();
  }

  let incomeHidden=true,balanceHidden=true;
  document.getElementById("eyeIncome").onclick=()=>{incomeHidden=!incomeHidden;render();};
  document.getElementById("eyeBalance").onclick=()=>{balanceHidden=!balanceHidden;render();};

  document.getElementById("btnPrint").onclick=()=>window.print();
  </script>
</body>
</html>
