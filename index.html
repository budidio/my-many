<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Keuangan Bulanan â€” Firebase</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script type="module">
    // --- Firebase Setup ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ðŸ”¥ GANTI BAGIAN INI DENGAN CONFIG FIREBASE KAMU ðŸ”¥
    const firebaseConfig = {
      apiKey: "AIzaSyC7TL5MZ7ufqpTQiO0eXw9OYV7sp7RUO5w",
      authDomain: "keuangan-app-ff36d.firebaseapp.com",|
      projectId: "keuangan-app-ff36d",
      storageBucket: "keuangan-app-ff36d.firebasestorage.app",
      messagingSenderId: "583666780989",
      appId: "1:583666780989:web:f84a73839ca0a76d6c1354"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- AUTH ---
    const CORRECT_USER = 'admin';
    const CORRECT_PASS = '1122aabb';
    const LS_AUTH = 'keuangan_auth_v3';
    const loginCard = document.getElementById('loginCard');
    const dash = document.getElementById('dash');
    const loginErr = document.getElementById('loginErr');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const usernameEl = document.getElementById('username');
    const passwordEl = document.getElementById('password');

    function setAuth(v){ localStorage.setItem(LS_AUTH, JSON.stringify({logged:v})); }
    function getAuth(){ try{return JSON.parse(localStorage.getItem(LS_AUTH)||'{}').logged}catch(e){return false} }

    btnLogin.addEventListener('click', ()=>{
      if(usernameEl.value===CORRECT_USER && passwordEl.value===CORRECT_PASS){
        loginErr.style.display='none'; setAuth(true); showDashboard();
      } else {
        loginErr.textContent='Username atau password salah.'; loginErr.style.display='block';
      }
    });
    btnLogout.addEventListener('click',()=>{ setAuth(false); hideDashboard(); });
    function showDashboard(){ loginCard.classList.add('hide'); dash.classList.remove('hide'); render(); }
    function hideDashboard(){ loginCard.classList.remove('hide'); dash.classList.add('hide'); }

    if(getAuth()) showDashboard();

    // --- UI Refs ---
    const monthPicker = document.getElementById('monthPicker');
    const dateInput = document.getElementById('date');
    const descInput = document.getElementById('desc');
    const typeInput = document.getElementById('type');
    const amountInput = document.getElementById('amount');
    const tbody = document.getElementById('entriesTable');
    const totalIncomeEl = document.getElementById('totalIncome');
    const totalExpenseEl = document.getElementById('totalExpense');
    const balanceEl = document.getElementById('balance');
    const countEl = document.getElementById('count');
    const limitValue = document.getElementById('limitValue');
    const viewMode = document.getElementById('viewMode');

    let editingId = null;
    let currentLimit = null;
    const entriesCol = collection(db, "keuangan_entries");

    // --- Chart ---
    const ctx = document.getElementById('chart').getContext('2d');
    const chartConfig = { type:'line', data:{labels:[],datasets:[]}, options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:true}},scales:{y:{beginAtZero:true}}}};
    let myChart = new Chart(ctx, chartConfig);

    // --- Util ---
    function fmt(n){ return Number(n).toLocaleString('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}); }

    // --- CRUD (Firestore) ---
    async function getEntriesByMonth(ym){
      const q = query(entriesCol, where("month","==", ym));
      const snap = await getDocs(q);
      return snap.docs.map(d=>({id:d.id, ...d.data()}));
    }

    async function addEntry(obj){
      obj.month = obj.date.slice(0,7);
      await addDoc(entriesCol, obj);
    }

    async function updateEntry(id,obj){
      const ref = doc(db,"keuangan_entries",id);
      await updateDoc(ref,obj);
    }

    async function deleteEntry(id){
      const ref = doc(db,"keuangan_entries",id);
      await deleteDoc(ref);
    }

    // --- Entry Form ---
    document.getElementById('entryForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const date=dateInput.value, desc=descInput.value.trim(), type=typeInput.value, amt=Math.abs(Number(amountInput.value)||0);
      if(!date||!desc||!amt){alert("Lengkapi semua data.");return;}
      const obj={date,desc,type,amount:amt};
      if(editingId){ await updateEntry(editingId,obj); editingId=null; document.getElementById('submitBtn').textContent='Tambah'; }
      else{ await addEntry(obj); }
      e.target.reset(); render();
    });

    tbody.addEventListener('click',async ev=>{
      const btn=ev.target.closest('button'); if(!btn)return;
      const id=btn.dataset.idx, act=btn.dataset.act;
      if(act==='edit'){
        const row = JSON.parse(btn.dataset.row);
        dateInput.value=row.date; descInput.value=row.desc; typeInput.value=row.type; amountInput.value=row.amount;
        editingId=id; document.getElementById('submitBtn').textContent='Update';
      } else if(act==='del'){
        if(confirm('Hapus transaksi?')){ await deleteEntry(id); render(); }
      }
    });

    document.getElementById('clearMonth').addEventListener('click', async ()=>{
      const ym=monthPicker.value; if(!ym)return;
      if(confirm('Hapus semua transaksi bulan '+ym+'?')){
        const list=await getEntriesByMonth(ym);
        for(const it of list){ await deleteEntry(it.id); }
        render();
      }
    });

    document.getElementById('applyLimit').addEventListener('click',()=>{ currentLimit=Number(limitValue.value)||null; render(); });
    monthPicker.addEventListener('change',render);
    viewMode.addEventListener('change',render);

    // --- RENDER ---
    async function render(){
      const ym=monthPicker.value;
      const visible=await getEntriesByMonth(ym);
      visible.sort((a,b)=>a.date.localeCompare(b.date));
      tbody.innerHTML = visible.map(r=>`
        <tr>
          <td>${r.date}</td>
          <td>${r.desc}</td>
          <td>${r.type}</td>
          <td class="right">${fmt(r.amount)}</td>
          <td>
            <button data-act="edit" data-idx="${r.id}" data-row='${JSON.stringify(r)}'>Edit</button>
            <button data-act="del" data-idx="${r.id}" class="danger">Hapus</button>
          </td>
        </tr>`).join('') || `<tr><td colspan="5" class="muted">Belum ada transaksi</td></tr>`;

      const totalIncome = visible.filter(v=>v.type==='income').reduce((s,v)=>s+v.amount,0);
      const totalExpense = visible.filter(v=>v.type==='expense').reduce((s,v)=>s+v.amount,0);
      totalIncomeEl.textContent=fmt(totalIncome);
      totalExpenseEl.textContent=fmt(totalExpense);
      balanceEl.textContent=fmt(totalIncome-totalExpense);
      countEl.textContent=visible.length;
      renderChart(ym,visible);
    }

    function renderChart(ym,entries){
      const [y,m]=ym.split('-').map(Number);
      const daysInMonth=new Date(y,m,0).getDate();
      let labels=[],dataPoints=[];
      if(viewMode.value==='weekly'){
        labels=['Minggu 1','Minggu 2','Minggu 3','Minggu 4'];
        const weekly=[0,0,0,0];
        entries.forEach(e=>{const d=new Date(e.date).getDate(); const idx=Math.min(3,Math.floor((d-1)/7)); weekly[idx]+=(e.type==='income'?e.amount:-e.amount);});
        dataPoints=weekly;
      }else{
        labels=Array.from({length:daysInMonth},(_,i)=>String(i+1));
        const daily=new Array(daysInMonth).fill(0);
        entries.forEach(e=>{const d=new Date(e.date).getDate(); daily[d-1]+=(e.type==='income'?e.amount:-e.amount);});
        dataPoints=daily;
      }
      const cumulative=[]; let acc=0; for(let i=0;i<dataPoints.length;i++){acc+=dataPoints[i]; cumulative.push(acc);}
      chartConfig.data={labels,datasets:[
        {label:'Periode (net)',data:dataPoints,borderWidth:2,tension:0.25,fill:true,backgroundColor:'rgba(37,99,235,0.08)'},
        {label:'Kumulatif',data:cumulative,borderWidth:2,tension:0.25,borderDash:[6,6],pointRadius:0}
      ]};
      if(currentLimit!==null) chartConfig.data.datasets.push({label:'Batas',data:new Array(labels.length).fill(currentLimit),borderWidth:1,borderDash:[8,4],pointRadius:0});
      myChart.data=chartConfig.data; myChart.options=chartConfig.options; myChart.update();
    }

    // init bulan & teks
    const today=new Date(); monthPicker.value=today.toISOString().slice(0,7);
    document.getElementById('currentMonth').textContent=today.toLocaleString('id-ID',{month:'long',year:'numeric'});
  </script>

  <style>
    :root{--bg:#f3f6fb;--card:#fff;--muted:#6b7280;--accent:#2563eb;}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,0.05)}
    .hide{display:none}
    input,select,button{padding:8px 10px;border-radius:8px;border:1px solid #ddd}
    button{cursor:pointer;background:var(--accent);color:white;font-weight:600;border:0}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #cfe1ff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eef4ff;text-align:left;font-size:14px}
    .right{text-align:right}
    .summary{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
    .summary .item{background:#f9fbff;border:1px solid #e8f0ff;padding:10px;border-radius:8px}
    .muted{color:var(--muted)}
    @media(min-width:800px){.summary{grid-template-columns:repeat(4,1fr)}}
    .chart-container{height:160px;width:100%;background:#fff;border-radius:10px;border:1px solid #e8f0ff;padding:10px;margin-top:10px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel" style="width:100%;max-width:980px">
      <div id="loginCard" class="card">
        <div class="title" style="color:var(--accent);font-weight:700;text-align:center;margin-bottom:10px">Masuk â€” Sistem Keuangan</div>
        <label>Username</label>
        <input id="username" type="text" placeholder="admin" />
        <label>Password</label>
        <input id="password" type="password" placeholder="1122aabb" />
        <button id="btnLogin" style="margin-top:10px">Masuk</button>
        <div id="loginErr" class="muted" style="display:none;color:#b91c1c;margin-top:8px"></div>
      </div>

      <div id="dash" class="card hide">
        <div class="topbar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div><div style="font-weight:700;color:var(--accent)">Keuangan Bulanan</div><div class="muted" id="currentMonth"></div></div>
          <button id="btnLogout" class="ghost">Keluar</button>
        </div>

        <form id="entryForm" class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <input type="date" id="date" required>
          <input type="text" id="desc" placeholder="Deskripsi" required>
          <select id="type"><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option></select>
          <input type="number" id="amount" placeholder="Nominal" required>
          <button id="submitBtn" type="submit">Tambah</button>
          <button id="clearMonth" type="button" class="ghost">Bersihkan bulan</button>
        </form>

        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <div><label class="muted" style="margin-right:6px">Bulan</label><input type="month" id="monthPicker"></div>
          <div><label class="muted" style="margin-right:6px">Tampilan</label>
            <select id="viewMode"><option value="daily">Harian</option><option value="weekly">Mingguan</option></select>
          </div>
          <div><input type="number" id="limitValue" placeholder="Batas nominal"><button id="applyLimit" class="ghost">Atur</button></div>
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table><thead><tr><th>Tanggal</th><th>Deskripsi</th><th>Jenis</th><th class="right">Nominal</th><th>Aksi</th></tr></thead><tbody id="entriesTable"></tbody></table>
        </div>

        <div class="summary">
          <div class="item"><div class="muted">Total Pemasukan</div><div id="totalIncome">0</div></div>
          <div class="item"><div class="muted">Total Pengeluaran</div><div id="totalExpense">0</div></div>
          <div class="item"><div class="muted">Saldo</div><div id="balance">0</div></div>
          <div class="item"><div class="muted">Transaksi</div><div id="count">0</div></div>
        </div>
        <div class="chart-container"><canvas id="chart"></canvas></div>
      </div>
    </div>
  </div>
</body>
</html>
